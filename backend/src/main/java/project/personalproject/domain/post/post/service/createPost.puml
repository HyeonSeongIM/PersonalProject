@startuml
actor User as U
participant "Client" as C
participant "API Server" as S
participant "PostService" as PS
participant "PostImageService" as PIS
database "MySQL" as DB
database "MinIO" as M

U -> C: 새 글 작성(제목/내용/이미지)

== Post 본문 생성 ==
C -> S: POST /api/v1/posts (title, content)

opt Request validation (@Valid DTO)
  S -> S: @NotBlank(title), @Size, 금지어 체크
  alt [invalid]
    S --> C: 400 ValidationError (field errors)
    return
  end
end

S -> PS: 게시글 생성 요청
PS -> DB: INSERT Post
DB --> PS: postId
PS --> S: postId

== 이미지 업로드 ==

opt Request validation
  S -> S: postId 형식, files 개수 ≤ 5, 확장자/MIME
  alt [invalid]
    S --> C: 400 Bad Request
    return
  end
end


opt Business validation (소유/상태)
  PIS -> DB: SELECT Post WHERE id=postId
  DB --> PIS: 결과
  alt [not found]
    PIS --> S: NotFound
    S --> C: 404 Not Found
    return
  else [forbidden]
    PIS --> S: Forbidden
    S --> C: 403 Forbidden
    return
  end
end

group TX(PostImage)
  loop 각 파일
    PIS -> PIS: newFileName()  'ex) posts/{postId}/{uuid}.{ext}
    PIS -> M: putObject(file, objectKey)
    M --> PIS: OK (etag)
    PIS -> DB: INSERT PostImage(postId, imageName)
    DB --> PIS: OK
  end
  alt [DB constraint violation]
    PIS --> S: PersistError
    S --> C: 409/422 ConstraintError
    break
  else [OK]
    PIS --> S: Post{title, content, images}
    S --> C: 201 Created
  end
end

@enduml
