@startuml
actor User as U
participant "Client" as C
participant "API Server" as S
participant "PostService\n(@Transactional REQUIRED)" as PS
participant "PostImageService\n(@Transactional REQUIRED)" as PIS
participant "PostImageIoService\n(@Transactional NOT_SUPPORTED)" as PIO #CCCCCC
database "MySQL" as DB
collections "MinIO" as M

U -> C: 새 글 작성(제목/내용/이미지)
C -> S: POST /api/v1/posts {title, content, images[]}

opt Request validation (@Valid DTO)
  S -> S: @NotBlank(title), @Size, 금지어 체크
  alt [invalid]
    S --> C: 400 ValidationError
    return
  end
end

== 본문 + 이미지 (한 요청에서 처리) ==
group TX[createPost() 트랜잭션 시작 - REQUIRED]
  activate PS
  S -> PS: 게시글 생성 요청

  PS -> DB: INSERT post(...)
  DB --> PS: postId

  PS -> PIS: createImages(post, images[])

  loop 트랜잭션 일시정지
    PIS -> PIS: newFileName()
    PIS -> M: putObject(file, objectKey)
    M --> PIS: 200 OK (etag)
    PIS -> DB: INSERT post_image(postId, imageName)
    DB --> PIS: OK
  end
end

    PIS -> PS: OK
    PS --> S: PostResponse{ id=postId, ... }

S --> C: 201 Created + PostResponse(+images)
@enduml
